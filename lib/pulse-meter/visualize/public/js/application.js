// Generated by CoffeeScript 1.2.1-pre
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; };

  document.startApp = function() {
    var AppRouter, AreaPresenter, DynamicWidgetView, GaugePresenter, LinePresenter, PageInfo, PageInfoList, PageTitleView, PageTitlesView, PiePresenter, SensorInfo, SensorInfoList, SensorInfoListView, SeriesPresenter, TablePresenter, TimelinePresenter, Widget, WidgetChartView, WidgetList, WidgetListView, WidgetPresenter, WidgetView, appRouter, dynamicWidget, globalOptions, pageInfos, pageTitlesApp, widgetList, widgetListApp;
    globalOptions = gon.options;
    String.prototype.capitalize = function() {
      return this.charAt(0).toUpperCase() + this.slice(1);
    };
    String.prototype.strip = function() {
      if (String.prototype.trim != null) {
        return this.trim();
      } else {
        return this.replace(/^\s+|\s+$/g, "");
      }
    };
    PageInfo = Backbone.Model.extend({});
    PageInfoList = Backbone.Collection.extend({
      model: PageInfo,
      selected: function() {
        return this.find(function(m) {
          return m.get('selected');
        });
      },
      selectFirst: function() {
        if (this.length > 0) return this.at(0).set('selected', true);
      },
      selectNone: function() {
        return this.each(function(m) {
          return m.set('selected', false);
        });
      },
      selectPage: function(id) {
        return this.each(function(m) {
          return m.set('selected', m.id === id);
        });
      }
    });
    pageInfos = new PageInfoList;
    PageTitleView = Backbone.View.extend({
      tagName: 'li',
      template: _.template('<a href="#/pages/<%= id  %>"><%= title %></a>'),
      initialize: function() {
        this.model.bind('change', this.render, this);
        return this.model.bind('destroy', this.remove, this);
      },
      render: function() {
        this.$el.html(this.template(this.model.toJSON()));
        if (this.model.get('selected')) {
          return this.$el.addClass('active');
        } else {
          return this.$el.removeClass('active');
        }
      }
    });
    PageTitlesView = Backbone.View.extend({
      initialize: function() {
        return pageInfos.bind('reset', this.render, this);
      },
      addOne: function(pageInfo) {
        var view;
        view = new PageTitleView({
          model: pageInfo
        });
        view.render();
        return $('#page-titles').append(view.el);
      },
      render: function() {
        $('#page-titles').empty();
        return pageInfos.each(this.addOne);
      }
    });
    pageTitlesApp = new PageTitlesView;
    pageInfos.reset(gon.pageInfos);
    WidgetPresenter = (function() {

      WidgetPresenter.name = 'WidgetPresenter';

      function WidgetPresenter(model, el) {
        var chartClass;
        this.model = model;
        chartClass = this.chartClass();
        this.chart = new chartClass(el);
        this.draw();
      }

      WidgetPresenter.prototype.get = function(arg) {
        return this.model.get(arg);
      };

      WidgetPresenter.prototype.dateOffset = function() {
        if (globalOptions.useUtc) {
          return (new Date).getTimezoneOffset() * 60000;
        } else {
          return 0;
        }
      };

      WidgetPresenter.prototype.options = function() {
        return {
          title: this.get('title'),
          height: 300
        };
      };

      WidgetPresenter.prototype.mergedOptions = function() {
        return $.extend(true, this.options(), globalOptions.gchartOptions, pageInfos.selected().get('gchartOptions'), this.get('gchartOptions'));
      };

      WidgetPresenter.prototype.data = function() {
        return new google.visualization.DataTable;
      };

      WidgetPresenter.prototype.chartClass = function() {
        return google.visualization[this.visualization];
      };

      WidgetPresenter.prototype.cutoff = function() {};

      WidgetPresenter.prototype.cutoffValue = function(v, min, max) {
        if (v != null) {
          if ((min != null) && v < min) {
            return min;
          } else if ((max != null) && v > max) {
            return max;
          } else {
            return v;
          }
        } else {
          return 0;
        }
      };

      WidgetPresenter.prototype.draw = function(min, max) {
        this.cutoff(min, max);
        return this.chart.draw(this.data(), this.mergedOptions());
      };

      return WidgetPresenter;

    })();
    WidgetPresenter.create = function(model, el) {
      var presenterClass, type;
      type = model.get('type');
      if ((type != null) && type.match(/^\w+$/)) {
        presenterClass = eval("" + (type.capitalize()) + "Presenter");
        return new presenterClass(model, el);
      } else {
        return null;
      }
    };
    PiePresenter = (function(_super) {

      __extends(PiePresenter, _super);

      PiePresenter.name = 'PiePresenter';

      function PiePresenter() {
        return PiePresenter.__super__.constructor.apply(this, arguments);
      }

      PiePresenter.prototype.visualization = 'PieChart';

      PiePresenter.prototype.cutoff = function() {};

      PiePresenter.prototype.data = function() {
        var data;
        data = PiePresenter.__super__.data.call(this);
        data.addColumn('string', 'Title');
        data.addColumn('number', this.get('valuesTitle'));
        data.addRows(this.get('series').data);
        return data;
      };

      PiePresenter.prototype.options = function() {
        return $.extend(true, PiePresenter.__super__.options.call(this), {
          slices: this.get('series').options,
          legend: {
            position: 'bottom'
          }
        });
      };

      return PiePresenter;

    })(WidgetPresenter);
    TimelinePresenter = (function(_super) {

      __extends(TimelinePresenter, _super);

      TimelinePresenter.name = 'TimelinePresenter';

      function TimelinePresenter() {
        return TimelinePresenter.__super__.constructor.apply(this, arguments);
      }

      TimelinePresenter.prototype.data = function() {
        var data, dateOffset, series;
        data = TimelinePresenter.__super__.data.call(this);
        data.addColumn('datetime', 'Time');
        dateOffset = this.dateOffset() + this.get('interval') * 1000;
        series = this.get('series');
        _.each(series.titles, function(t) {
          return data.addColumn('number', t);
        });
        _.each(series.rows, function(row) {
          row[0] = new Date(row[0] + dateOffset);
          return data.addRow(row);
        });
        return data;
      };

      return TimelinePresenter;

    })(WidgetPresenter);
    SeriesPresenter = (function(_super) {

      __extends(SeriesPresenter, _super);

      SeriesPresenter.name = 'SeriesPresenter';

      function SeriesPresenter() {
        return SeriesPresenter.__super__.constructor.apply(this, arguments);
      }

      SeriesPresenter.prototype.options = function() {
        var format, secondPart;
        secondPart = this.get('interval') % 60 === 0 ? '' : ':ss';
        format = this.model.timespan() > 24 * 60 * 60 ? "yyyy.MM.dd HH:mm" + secondPart : "HH:mm" + secondPart;
        return $.extend(true, SeriesPresenter.__super__.options.call(this), {
          lineWidth: 1,
          chartArea: {
            left: 40,
            width: '100%'
          },
          legend: {
            position: 'bottom'
          },
          vAxis: {
            title: "" + (this.get('valuesTitle')) + " / " + (this.humanizedInterval())
          },
          hAxis: {
            format: format
          },
          series: this.get('series').options,
          axisTitlesPosition: 'in'
        });
      };

      SeriesPresenter.prototype.humanizedInterval = function() {
        var d, h, interval, m, res, s;
        interval = this.get('interval');
        res = "";
        s = interval % 60;
        if (s > 0) res = "" + s + " s";
        interval = (interval - s) / 60;
        if (!(interval > 0)) return res;
        m = interval % 60;
        if (m > 0) res = ("" + m + " m " + res).strip();
        interval = (interval - m) / 60;
        if (!(interval > 0)) return res;
        h = interval % 24;
        if (h > 0) res = ("" + h + " h " + res).strip();
        d = (interval - h) / 24;
        if (d > 0) {
          return ("" + d + " d " + res).strip();
        } else {
          return res;
        }
      };

      SeriesPresenter.prototype.cutoff = function(min, max) {
        return _.each(this.get('series').rows, function(row) {
          var i, value, _i, _ref, _results;
          _results = [];
          for (i = _i = 1, _ref = row.length - 1; 1 <= _ref ? _i <= _ref : _i >= _ref; i = 1 <= _ref ? ++_i : --_i) {
            value = row[i];
            if (value == null) value = 0;
            _results.push(row[i] = this.cutoffValue(value, min, max));
          }
          return _results;
        }, this);
      };

      return SeriesPresenter;

    })(TimelinePresenter);
    LinePresenter = (function(_super) {

      __extends(LinePresenter, _super);

      LinePresenter.name = 'LinePresenter';

      function LinePresenter() {
        return LinePresenter.__super__.constructor.apply(this, arguments);
      }

      LinePresenter.prototype.visualization = 'LineChart';

      return LinePresenter;

    })(SeriesPresenter);
    AreaPresenter = (function(_super) {

      __extends(AreaPresenter, _super);

      AreaPresenter.name = 'AreaPresenter';

      function AreaPresenter() {
        return AreaPresenter.__super__.constructor.apply(this, arguments);
      }

      AreaPresenter.prototype.visualization = 'AreaChart';

      return AreaPresenter;

    })(SeriesPresenter);
    TablePresenter = (function(_super) {

      __extends(TablePresenter, _super);

      TablePresenter.name = 'TablePresenter';

      function TablePresenter() {
        return TablePresenter.__super__.constructor.apply(this, arguments);
      }

      TablePresenter.prototype.visualization = 'Table';

      TablePresenter.prototype.cutoff = function() {};

      TablePresenter.prototype.options = function() {
        return $.extend(true, TablePresenter.__super__.options.call(this), {
          sortColumn: 0,
          sortAscending: false
        });
      };

      return TablePresenter;

    })(TimelinePresenter);
    GaugePresenter = (function(_super) {

      __extends(GaugePresenter, _super);

      GaugePresenter.name = 'GaugePresenter';

      function GaugePresenter() {
        return GaugePresenter.__super__.constructor.apply(this, arguments);
      }

      GaugePresenter.prototype.visualization = 'Gauge';

      GaugePresenter.prototype.cutoff = function() {};

      GaugePresenter.prototype.data = function() {
        var data;
        data = GaugePresenter.__super__.data.call(this);
        data.addColumn('string', 'Label');
        data.addColumn('number', this.get('valuesTitle'));
        data.addRows(this.get('series'));
        return data;
      };

      return GaugePresenter;

    })(WidgetPresenter);
    Widget = Backbone.Model.extend({
      initialize: function() {
        this.needRefresh = true;
        this.setNextFetch();
        return this.timespanInc = 0;
      },
      increaseTimespan: function(inc) {
        this.timespanInc = this.timespanInc + inc;
        return this.forceUpdate();
      },
      resetTimespan: function() {
        this.timespanInc = 0;
        return this.forceUpdate();
      },
      timespan: function() {
        return this.get('timespan') + this.timespanInc;
      },
      url: function() {
        var timespan;
        timespan = this.timespan();
        if (_.isNaN(timespan)) {
          return "" + (this.collection.url()) + "/" + (this.get('id'));
        } else {
          return "" + (this.collection.url()) + "/" + (this.get('id')) + "?timespan=" + timespan;
        }
      },
      time: function() {
        return (new Date()).getTime();
      },
      setNextFetch: function() {
        return this.nextFetch = this.time() + this.get('redrawInterval') * 1000;
      },
      setRefresh: function(needRefresh) {
        return this.needRefresh = needRefresh;
      },
      needFetch: function() {
        var interval;
        interval = this.get('redrawInterval');
        return this.time() > this.nextFetch && this.needRefresh && (interval != null) && interval > 0;
      },
      refetch: function() {
        if (this.needFetch()) {
          this.forceUpdate();
          return this.setNextFetch();
        }
      },
      forceUpdate: function() {
        return this.fetch({
          success: function(model, response) {
            return model.trigger('redraw');
          }
        });
      }
    });
    WidgetList = Backbone.Collection.extend({
      model: Widget,
      url: function() {
        return ROOT + 'pages/' + pageInfos.selected().id + '/widgets';
      }
    });
    SensorInfo = Backbone.Model.extend({});
    SensorInfoList = Backbone.Collection.extend({
      model: SensorInfo,
      url: function() {
        return ROOT + 'widgets';
      }
    });
    SensorInfoListView = Backbone.View.extend({
      tagName: 'div'
    });
    DynamicWidgetView = Backbone.View.extend({
      initialize: function() {},
      render: function() {
        var container;
        container = $('#widgets');
        return container.empty();
      }
    });
    dynamicWidget = new DynamicWidgetView;
    WidgetChartView = Backbone.View.extend({
      tagName: 'div',
      initialize: function() {
        return this.model.bind('destroy', this.remove, this);
      },
      updateData: function(min, max) {
        return this.presenter.draw(min, max);
      },
      render: function() {
        return this.presenter = WidgetPresenter.create(this.model, this.el);
      }
    });
    WidgetView = Backbone.View.extend({
      tagName: 'div',
      template: function() {
        return _.template($(".widget-template[data-widget-type=\"" + (this.model.get('type')) + "\"]").html());
      },
      initialize: function() {
        this.model.bind('destroy', this.remove, this);
        return this.model.bind('redraw', this.updateChart, this);
      },
      events: {
        "click #refresh": 'refresh',
        "click #need-refresh": 'setRefresh',
        "click #extend-timespan": 'extendTimespan',
        "click #reset-timespan": 'resetTimespan'
      },
      refresh: function() {
        return this.model.forceUpdate();
      },
      setRefresh: function() {
        var needRefresh;
        needRefresh = this.$el.find('#need-refresh').is(":checked");
        this.model.setRefresh(needRefresh);
        return true;
      },
      extendTimespan: function() {
        var select, val;
        select = this.$el.find("#extend-timespan-val");
        val = select.first().val();
        return this.model.increaseTimespan(parseInt(val));
      },
      resetTimespan: function() {
        return this.model.resetTimespan();
      },
      renderChart: function() {
        return this.chartView.render();
      },
      updateChart: function() {
        return this.chartView.updateData(this.cutoffMin(), this.cutoffMax());
      },
      render: function() {
        this.$el.html(this.template(this.model.toJSON()));
        this.chartView = new WidgetChartView({
          model: this.model
        });
        this.$el.find("#plotarea").append(this.chartView.el);
        return this.$el.addClass("span" + (this.model.get('width')));
      },
      cutoffMin: function() {
        var val;
        val = parseFloat(this.controlValue('#cutoff-min'));
        if (_.isNaN(val)) {
          return null;
        } else {
          return val;
        }
      },
      cutoffMax: function() {
        var val;
        val = parseFloat(this.controlValue('#cutoff-max'));
        if (_.isNaN(val)) {
          return null;
        } else {
          return val;
        }
      },
      controlValue: function(id) {
        var val;
        return val = this.$el.find(id).first().val();
      }
    });
    widgetList = new WidgetList;
    setInterval(function() {
      if (pageInfos.selected()) {
        return widgetList.each(function(w) {
          return w.refetch();
        });
      }
    }, 200);
    WidgetListView = Backbone.View.extend({
      initialize: function() {
        return widgetList.bind('reset', this.render, this);
      },
      render: function() {
        var container;
        container = $('#widgets');
        container.empty();
        return widgetList.each(function(w) {
          var view;
          view = new WidgetView({
            model: w
          });
          view.render();
          container.append(view.el);
          return view.renderChart();
        });
      }
    });
    widgetListApp = new WidgetListView;
    AppRouter = Backbone.Router.extend({
      routes: {
        'pages/:id': 'getPage',
        'dynamic': 'dynamic',
        '*actions': 'defaultRoute'
      },
      getPage: function(ids) {
        var id;
        id = parseInt(ids);
        pageInfos.selectPage(id);
        return widgetList.fetch();
      },
      dynamic: function() {
        pageInfos.selectNone();
        return dynamicWidget.render();
      },
      defaultRoute: function(actions) {
        if (pageInfos.length > 0) return this.navigate('//pages/1');
      }
    });
    appRouter = new AppRouter;
    return Backbone.history.start();
  };

}).call(this);
